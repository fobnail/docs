
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fobnail.3mdeb.com/tpm-simulators/">
      
      
        <link rel="prev" href="../token_provisioning/">
      
      
        <link rel="next" href="../debugging/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.5">
    
    
      
        <title>Using TPM simulators - Fobnail Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6a10b989.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tpm-simulators" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fobnail Documentation" class="md-header__button md-logo" aria-label="Fobnail Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fobnail Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Using TPM simulators
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fobnail Documentation" class="md-nav__button md-logo" aria-label="Fobnail Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Fobnail Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Supported Hardware
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Supported Hardware
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../fobnail_token/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fobnail Token
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Development Process
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Development Process
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../fobnail-sdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fobnail SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloning and building
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../flashing_preparation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flashing preparation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../networking_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Networking setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../token_provisioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Token provisioning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Using TPM simulators
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Using TPM simulators
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#differences-between-simulated-and-real-tpm" class="md-nav__link">
    Differences between simulated and real TPM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provisioning-simulated-tpm" class="md-nav__link">
    Provisioning simulated TPM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-simulated-tpm" class="md-nav__link">
    Using simulated TPM
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Example Applications
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Example Applications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../examples/disk_encryption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk encryption
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Knowledge Base
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Knowledge Base
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../description/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Detailed description
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../keys_and_certificates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Keys and certificates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../fobnail-api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fobnail API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blink-codes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fobnail blink codes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ek_certificates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EK certificate chain sizes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ethernet over USB
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Ethernet over USB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../eth-over-usb-research/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../implementing-eth-over-usb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Implementation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Minimal OSes used with Fobnail Token
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Minimal OSes used with Fobnail Token
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../minimal-os-for-fobnail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../meta-fobnail-in-dlme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta-fobnail PoC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../zephyr-in-dlme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zephyr PoC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../xen-in-dlme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Xen PoC
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archived
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Archived
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../archive/environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Environment setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../archive/local_development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developing firmware on PC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../archive/charra-concept-on-pc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run CHARRA concept on PC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../archive/preparation_for_tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preparation for tests
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#differences-between-simulated-and-real-tpm" class="md-nav__link">
    Differences between simulated and real TPM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#provisioning-simulated-tpm" class="md-nav__link">
    Provisioning simulated TPM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-simulated-tpm" class="md-nav__link">
    Using simulated TPM
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="tpm-simulators">TPM simulators</h1>
<p>It is possible to use TPM simulators instead of real TPMs <strong>for testing purposes
only</strong>. Two simulators were tested and are known to be working with Fobnail:
<a href="https://github.com/microsoft/ms-tpm-20-ref">Microsoft's</a> and
<a href="https://sourceforge.net/projects/ibmswtpm2/">IBM's</a>.</p>
<h2 id="differences-between-simulated-and-real-tpm">Differences between simulated and real TPM</h2>
<p>The main difference is that simulator is started after system is up. This means
that there will be no measurements of firmware nor OS. Attestation is based on
these measurements, without them there is nothing to attest to, which makes use
of simulated TPM useless for practical applications. It also means that nothing
called <code>TPM2_Startup</code> command. Attester is able to detect this and calls that
function automatically.</p>
<p>Hardware and firmware TPM vendors give assurance of proper functioning of their
TPMs. This is done by creating a certificate for each TPM separately,
specifically for their Endorsement Keys (EKs). These certificates are created
during TPM manufacturing and provisioning process, and are written to NVRAM.
They point to their signing certificates through <code>authorityInfoAccess</code> X509V3
extension. The chain continues until a self-signed root that is implicitly
trusted. That root must be known by Fobnail Token in advance in order to trust
given TPM.</p>
<p>For simulated TPM, such certificate has to be manually created and injected into
NVRAM. EK certificate is created for EK created from EPS (Endorsement Primary
Seed), which is randomly created when the simulator is started for the first
time. Nobody is issuing certificates for all instances of simulated TPMs. One of
the reasons is probably the fact that emulators are not fully compatible with
specification, especially when it comes to hardware protection mechanisms
(Physical Presence, protected storage etc.).</p>
<p>There are also other small differences, e.g. after non-orderly shutdown <code>safe</code>
field in <code>TPMS_CLOCK_INFO</code> structure is set after 12 seconds in simulator, while
specification allows for up to 2^22 milliseconds (around 70 minutes) to help
with NVRAM wear leveling. Note that this field is checked by Fobnail during
attestation.</p>
<h2 id="building">Building</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">ms-tpm-20-ref</label><label for="__tabbed_1_2">ibmswtpm2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Clone the repository and checkout commit that is known to work
(unfortunately, this repository doesn't use tags):</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/microsoft/ms-tpm-20-ref.git
<span class="nb">cd</span><span class="w"> </span>ms-tpm-20-ref/TPMCmd/
git<span class="w"> </span>checkout<span class="w"> </span>f74c0d9686625c02b0fdd5b2bbe792a22aa96cb6
</code></pre></div>
<p>Install prerequisites:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>autoconf-archive<span class="w"> </span>pkg-config<span class="w"> </span>build-essential<span class="w"> </span>automake<span class="w"> </span><span class="se">\</span>
<span class="w">     </span>tss2<span class="w"> </span>libssl-dev
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code>./bootstrap
./configure
make
</code></pre></div>
<p>TPM simulator is started with:</p>
<div class="highlight"><pre><span></span><code>./Simulator/src/tpm2-simulator
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Clone the repository and checkout tag that is known to work:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://git.code.sf.net/p/ibmswtpm2/tpm2<span class="w"> </span>ibmswtpm2-tpm2
<span class="nb">cd</span><span class="w"> </span>ibmswtpm2-tpm2/src/
git<span class="w"> </span>checkout<span class="w"> </span>rev1563
</code></pre></div>
<p>Install prerequisites:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>build-essential<span class="w"> </span>libssl-dev<span class="w"> </span>tss2
</code></pre></div>
<p>Compile:</p>
<div class="highlight"><pre><span></span><code>make
</code></pre></div>
<p>TPM simulator is started with:</p>
<div class="highlight"><pre><span></span><code>./tpm_server
</code></pre></div>
</div>
</div>
</div>
<p>The last command will create <code>NVChip</code> file in the current directory. Removing it
(while simulator is not running) will restore TPM to clean state.</p>
<hr />
<h2 id="provisioning-simulated-tpm">Provisioning simulated TPM</h2>
<p>As mentioned, EK certificate must be written to TPM NVRAM. In addition, it must
point to valid CA certificate that will be downloaded during platform
provisioning. A script for simplifying this process and required configuration
are included in <a href="https://github.com/fobnail/fobnail-attester/tree/main/tools">Attester's repository</a>.
<code>tpm2-tools</code> and <code>openssl</code> are used by this script, so they must be installed.</p>
<p>To create root certificate, EK certificate and write the latter to NVRAM, it is
enough to call the following (<code>-s</code> tells to send <code>TPM2_Startup</code> command):</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./tools/tpm_manufacture.sh<span class="w"> </span>-s
Sending<span class="w"> </span>TPM2_Startup<span class="w"> </span><span class="nb">command</span>
Generating<span class="w"> </span>a<span class="w"> </span>RSA<span class="w"> </span>private<span class="w"> </span>key
................................................+++++
................+++++
writing<span class="w"> </span>new<span class="w"> </span>private<span class="w"> </span>key<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;/home/user/fobnail-attester/tools/keys_and_certs/ca_priv.pem&#39;</span>
-----
Signature<span class="w"> </span>ok
<span class="nv">subject</span><span class="o">=</span><span class="nv">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>PL,<span class="w"> </span><span class="nv">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fobnail,<span class="w"> </span><span class="nv">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>State,<span class="w"> </span><span class="nv">CN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>EK<span class="w"> </span>certificate
Getting<span class="w"> </span>CA<span class="w"> </span>Private<span class="w"> </span>Key


Done.
To<span class="w"> </span>test:
<span class="w">        </span>tpm2_nvread<span class="w"> </span>-C<span class="w"> </span>o<span class="w"> </span>0x01C00002<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span>-inform<span class="w"> </span>DER
</code></pre></div>
<p>Check if certificate was written properly by executing suggested command:</p>
<div class="highlight"><pre><span></span><code>$ tpm2_nvread -C o 0x01C00002 | openssl x509 -text -noout -inform DER
WARN: Reading full size of the NV index
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            66:e5:d8:5a:1f:4b:38:95:67:9c:2a:b7:b1:2d:e5:55:e9:b2:ee:2e
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = PL, O = Fobnail, ST = State, CN = CA certificate
        Validity
            Not Before: Jan  4 19:14:00 2023 GMT
            Not After : Feb  3 19:14:00 2023 GMT
        Subject: C = PL, O = Fobnail, ST = State, CN = EK certificate
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:b1:a0:41:73:ca:33:e4:be:78:bf:21:e1:19:43:
                    22:1c:50:90:44:23:bd:a1:0b:d6:1c:9e:c7:bd:07:
                    c0:ba:1e:be:f3:b1:c7:32:9d:8a:99:64:6c:4b:6e:
                    7f:fe:9a:2a:58:50:34:cd:4b:a1:38:c4:f3:a2:25:
                    01:87:00:9d:75:5a:b6:8d:46:a6:c9:b6:8c:62:5c:
                    8d:95:1a:06:d9:38:79:d5:41:80:ce:e1:4e:23:f0:
                    fe:b3:43:58:05:13:38:7b:cb:c5:8c:b6:ea:6b:b1:
                    75:10:79:7b:f0:1e:99:01:94:43:5d:4b:85:22:a5:
                    66:cd:9c:c4:36:49:97:df:03:26:9c:2c:28:5a:1c:
                    6b:fc:59:3d:e8:94:e7:dc:21:74:25:9a:32:d1:21:
                    2b:98:8d:e4:c3:84:39:cc:eb:c6:1b:b6:05:97:c2:
                    61:22:ed:f4:3a:3c:31:e5:e2:c8:b6:41:f9:33:6d:
                    de:9e:3d:bf:bf:11:d8:e6:65:d8:7e:24:d1:11:00:
                    54:a6:71:f8:8e:04:a8:81:a7:51:22:07:2f:67:ee:
                    b7:11:8f:d9:f6:c9:07:b8:61:9b:ee:45:c6:2e:ad:
                    b0:26:5e:88:52:3b:5c:3d:82:36:45:26:00:35:c0:
                    4c:4a:3d:c9:6a:4a:4a:ed:32:65:51:e5:b4:a4:1c:
                    65:eb
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Authority Key Identifier:
                keyid:7C:12:EB:3F:07:E3:82:43:57:7C:0D:17:84:40:E3:70:CE:39:C2:E4

            Authority Information Access:
                CA Issuers - URI:http://127.0.0.1:8080/ca_cert.der

            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Key Encipherment
    Signature Algorithm: sha256WithRSAEncryption
         5e:b2:f9:76:a6:fe:25:31:ec:b5:c9:27:7b:96:9b:48:00:e2:
         17:da:cf:6e:2a:40:f4:8f:76:2c:d8:75:eb:42:45:43:ef:c0:
         db:56:53:1b:f8:57:4e:3d:56:3c:6b:83:8a:55:a8:53:cd:4c:
         c6:71:ed:8f:d0:80:6d:6d:5b:08:6f:07:60:7d:6c:c6:7e:37:
         00:6b:00:41:22:6b:2f:06:10:07:f0:3a:d4:f4:26:ca:32:a4:
         9a:30:f0:d5:0f:48:a4:dd:fd:59:8c:35:b2:5c:62:9f:71:db:
         4e:f0:37:68:10:38:c3:eb:96:f2:85:fa:32:ba:e2:9b:a5:94:
         df:9d:bd:df:69:ff:d8:98:40:2d:0c:30:d4:b4:76:db:fb:e6:
         a8:04:9d:81:83:66:24:83:8f:eb:4d:c4:9e:7f:da:18:22:1a:
         99:4e:15:f1:cf:56:05:37:c7:be:98:44:be:d6:d5:ae:e2:f6:
         7e:40:a7:07:c9:c0:b1:da:c6:b4:7b:bf:0b:41:89:5e:d4:76:
         98:51:81:1e:4f:dd:6c:f5:aa:5b:32:ed:ea:de:8b:cd:ca:f1:
         36:0a:41:0a:46:ff:44:d7:8a:fe:fe:c4:0f:d2:7c:53:76:ad:
         0f:df:1b:65:51:ed:05:7b:be:bf:8a:4e:68:65:4f:6d:3f:14:
         27:d3:2c:f3
</code></pre></div>
<blockquote>
<p>There may be more lines with warnings and even errors printed before that.
They come from TCTI (TPM Command Transmission Interface) and are caused by
failed attempts to use another interface (e.g. physical TPM) before driver
for simulator is tried. They can be safely ignored, as long as content of
certificate is printed afterwards.</p>
</blockquote>
<p>Certificate in <code>tools/keys_and_certs/ca_cert.der</code> is the one that has to be
passed to <code>build.sh</code> in <code>FOBNAIL_EXTRA_EK_ROOT</code> variable, see <a href="/building/#environment-variables-common-for-both-targets">building
instructions</a>
for details.</p>
<p>Configuration assumes that CA certificate will be made available at address
<code>http://127.0.0.1:8080/ca_cert.der</code>, to change this please edit <code>ek_v3.ext</code> in
<code>tools</code> directory.</p>
<p>If you have to re-run the manufacturing process (e.g. EK root certificate is
lost or some changes were done to its extensions) start <code>tpm_manufacture.sh</code>
with additional <code>-f</code> flag that will overwrite EK certificate even if it is
already present. <strong>Do not use it on real TPM, there is no way of recovering
original certificate if it was removed!</strong>.</p>
<p>Another option is to remove <code>NVChip</code> file. This option should be used if the
platform provisioning is to be repeated, as it also removes saved EK (not only
EK certificate) and AIK. In that case, <code>-f</code> is not required.</p>
<h2 id="using-simulated-tpm">Using simulated TPM</h2>
<p>For most cases running TPM simulator is enough. Only platform provisioning needs
HTTP server in addition to TPM simulator. Easiest way to do so is to use Python:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>tools/keys_and_certs
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span><span class="m">8080</span>
</code></pre></div>
<p>HTTP server can be closed after platform is successfully provisioned and never
started again, unless another provisioning is required.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>